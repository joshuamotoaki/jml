---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/blog.css";

interface Props {
  post: CollectionEntry<"blog">;
}

export async function getStaticPaths() {
  const includeDrafts = !import.meta.env.PROD;
  const posts = await getCollection("blog");
  const visiblePosts = posts.filter(
    (post) => includeDrafts || !post.data.draft
  );

  return visiblePosts.map((post) => ({
    params: { slug: post.data.permalink },
    props: { post },
  }));
}

const { post } = Astro.props as Props;
const { Content } = await post.render();
const siteUrl = Astro.site ?? new URL("https://motoaki.dev");
const canonicalUrl = new URL(`/blog/${post.data.permalink}/`, siteUrl);
const encodedUrl = encodeURIComponent(canonicalUrl.toString());
const encodedTitle = encodeURIComponent(post.data.title);
const dateFormatter = new Intl.DateTimeFormat("en-US", {
  dateStyle: "long",
  timeZone: "UTC",
});
const tagPalette = ["#e63946", "#f4845f", "#06d6a0", "#118ab2"];
const getTagColor = (tag: string) => {
  let hash = 0;
  const normalized = tag.trim().toLowerCase();
  for (const char of normalized) {
    hash = (hash * 31 + char.charCodeAt(0)) >>> 0;
  }
  return tagPalette[hash % tagPalette.length];
};
const shareLinks = {
  x: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
};
---

<BaseLayout title={`${post.data.title} | Blog | Joshua Motoaki Lau`}>
  <Fragment slot="head">
    <meta name="description" content={post.data.description} />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="JML Blog RSS"
      href="/rss.xml"
    />
  </Fragment>

  <div class="blog-shell">
    <svg class="blog-noise-svg" aria-hidden="true">
      <defs>
        <filter id="blogPageNoise">
          <feTurbulence
            baseFrequency="0.3"
            numOctaves="3"
            stitchTiles="noStitch"
          />
          <feColorMatrix type="saturate" values="0" />
        </filter>
      </defs>
    </svg>

    <article class="post-page">
      <nav class="blog-nav" aria-label="Post navigation">
        <a href="/" class="blog-kicker"><span class="zh">劉元明</span> Joshua Motoaki Lau</a>
        <div class="blog-nav-links">
          <button class="blog-kicker blog-kicker-button" data-about-trigger type="button">
            About
          </button>
          <a href="/rss.xml" class="blog-kicker">RSS</a>
        </div>
      </nav>

      <header class="post-header">
        <a href="/blog/" class="post-backlink">Back to blog</a>
        <h1 class="post-title">{post.data.title}</h1>
        <p class="post-dek">{post.data.description}</p>
        <p class="post-meta">
          <time datetime={post.data.pubDate.toISOString()}
            >{dateFormatter.format(post.data.pubDate)}</time
          >
          {
            post.data.updatedDate && (
              <span>
                {" "}
                · Updated{" "}
                <time datetime={post.data.updatedDate.toISOString()}>
                  {dateFormatter.format(post.data.updatedDate)}
                </time>
              </span>
            )
          }
        </p>
        <div class="blog-tags" aria-label="Tags">
          {post.data.tags.map((tag) => (
            <span class="blog-tag" style={`--blog-tag-color: ${getTagColor(tag)}`}>
              {tag}
            </span>
          ))}
        </div>
        <div class="post-share" aria-label="Share this post">
          <span class="post-share-label">Share</span>
          <div class="post-share-links">
            <button
              class="post-share-button"
              type="button"
              data-copy-url={canonicalUrl.toString()}
            >
              Copy link
            </button>
            <a
              class="post-share-link"
              href={shareLinks.x}
              target="_blank"
              rel="noopener noreferrer"
            >
              X
            </a>
          </div>
        </div>
      </header>

      <div class="post-content">
        <Content />
      </div>

      <footer class="post-footer" aria-label="Post footer">
        <a class="post-footer-button" href="/blog/">Back to blog list</a>
      </footer>
    </article>
  </div>
</BaseLayout>

<script is:inline>
  const copyButtons = document.querySelectorAll("[data-copy-url]");
  copyButtons.forEach((button) => {
    button.addEventListener("click", async () => {
      const url = button.getAttribute("data-copy-url");
      if (!url) return;
      const originalLabel = button.textContent || "Copy link";

      try {
        await navigator.clipboard.writeText(url);
        button.textContent = "Copied";
      } catch {
        window.prompt("Copy this link:", url);
      }

      window.setTimeout(() => {
        button.textContent = originalLabel;
      }, 1500);
    });
  });
</script>
