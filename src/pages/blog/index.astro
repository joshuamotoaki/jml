---
import { getCollection } from "astro:content";
import Header from "../../components/Header.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = posts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const tagColors: Record<string, string> = {
  thoughts: "bg-red-std",
  tech: "bg-blue-std",
  design: "bg-violet-std",
  personal: "bg-orange-std",
};

function getTagColor(tag: string): string {
  return tagColors[tag] || "bg-yellow-std";
}

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}
---

<BaseLayout title="Blog | Joshua Motoaki Lau">
  <Header currentPage="blog" />

  <div id="cont" class="relative w-full min-h-screen overflow-hidden bg-light">
    <!-- SVG Noise Filter -->
    <svg style="position: absolute; width: 0; height: 0;">
      <defs>
        <filter id="pageNoise">
          <feTurbulence
            baseFrequency="0.3"
            numOctaves="3"
            stitchTiles="noStitch"></feTurbulence>
          <feColorMatrix type="saturate" values="0"></feColorMatrix>
        </filter>
      </defs>
    </svg>

    <!-- Mirrored Color Bars (Left-anchored, all same length) -->
    <div class="absolute inset-0 z-10 pointer-events-none">
      <!-- Red Bar -->
      <div
        class="absolute left-0 w-[8%] md:w-[5%] h-16 md:h-32 bg-red-std fuzzy-bar-left top-[60%] md:top-[30%]"
      >
      </div>

      <!-- Yellow Bar -->
      <div
        class="absolute left-0 w-[8%] md:w-[5%] h-16 md:h-32 bg-yellow-std fuzzy-bar-left top-[75%] md:top-[55%]"
      >
      </div>

      <!-- Orange Bar -->
      <div
        class="absolute left-0 w-[8%] md:w-[5%] h-16 md:h-32 bg-orange-std fuzzy-bar-left top-[90%] md:top-[80%]"
      >
      </div>
    </div>

    <!-- Blog Content Area -->
    <main class="relative z-20 pt-24 md:pt-32 px-4 md:px-8 pb-48">
      <!-- Page Title - Sideways -->
      <div
        class="absolute top-32 md:top-40 right-4 md:right-8 rotate-90 origin-top-right"
      >
        <h1 class="text-h3 md:text-h1 font-ultralight italic text-dark">
          Blog
        </h1>
      </div>

      <!-- Posts List -->
      <div class="max-w-2xl ml-0 md:ml-[15%] space-y-12">
        {
          sortedPosts.length === 0 ? (
            <p class="text-h5 text-dark-hover italic">No posts yet.</p>
          ) : (
            sortedPosts.map((post) => (
              <article class="group">
                <a
                  href={`/blog/${post.id}`}
                  class="block hover:translate-x-2 transition-transform duration-150"
                >
                  <div class="flex flex-col md:flex-row md:items-start gap-2 md:gap-6">
                    <time
                      class="text-h6 text-dark-hover font-light whitespace-nowrap shrink-0"
                      datetime={post.data.date.toISOString()}
                    >
                      {formatDate(post.data.date)}
                    </time>

                    <div class="flex-1">
                      <h2 class="text-h4 md:text-h3 font-regular group-hover:text-dark-hover transition-colors">
                        {post.data.title}
                      </h2>

                      <div class="flex gap-2 mt-2 flex-wrap">
                        {post.data.tags.map((tag) => (
                          <span
                            class={`px-2 py-0.5 text-sm text-light ${getTagColor(tag)}`}
                          >
                            {tag}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                </a>
              </article>
            ))
          )
        }
      </div>
    </main>
  </div>
</BaseLayout>

<style lang="postcss">
  #cont::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100%;
    min-height: 100vh;
    background: rgba(0, 0, 0, 0.1);
    filter: url(#pageNoise);
    opacity: 0.33;
    pointer-events: none;
    z-index: 50;
  }

  .fuzzy-bar-left {
    box-shadow:
      0 0 20px rgba(0, 0, 0, 0.1),
      inset 0 0 20px rgba(255, 255, 255, 0.1);
    border-right: 1px solid rgba(255, 255, 255, 0.2);
  }

  .fuzzy-bar-left::before {
    content: "";
    position: absolute;
    top: -2px;
    bottom: -2px;
    left: -2px;
    right: -2px;
    background: inherit;
    filter: blur(2px);
    opacity: 0.3;
    z-index: -1;
  }
</style>
